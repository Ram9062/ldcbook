<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LDC Book Secure (Google Login)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { background-color: #f8f9fa; }
    .customer-card { margin-bottom: 15px; cursor: pointer; transition: 0.2s; }
    .customer-card:hover { transform: scale(1.02); }
    .transaction-list { max-height: 300px; overflow-y: auto; }
    .credit { color: green; }
    .debit { color: red; }
    #mainContent, #passwordModal { display: none; }
  </style>
</head>
<body>

<!-- Google Sign-In -->
<div id="googleSignInDiv" class="d-flex justify-content-center align-items-center vh-100">
  <div id="g_id_onload"
       data-client_id="553551404443-b4amscrqdjerd5t6kba627ulu6g52nks.apps.googleusercontent.com"
       data-callback="handleCredentialResponse"
       data-auto_prompt="true">
  </div>
  <div class="g_id_signin" data-type="standard" data-size="large"></div>
</div>

<!-- Password Modal -->
<div class="modal fade show" id="passwordModal" tabindex="-1" aria-hidden="true" style="display: block;">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Enter Password</h5>
      </div>
      <div class="modal-body">
        <input type="password" id="passwordInput" class="form-control mb-3" placeholder="Password">
        <button class="btn btn-primary w-100" onclick="checkPassword()">Enter</button>
        <div id="wrongPass" class="text-danger mt-2" style="display:none;">Wrong Password!</div>
        <button class="btn btn-outline-secondary w-100 mt-3" onclick="enterReadOnly()">View Only</button>
      </div>
    </div>
  </div>
</div>

<!-- Main Content -->
<div id="mainContent" class="container my-4">
  <h1 class="text-center mb-4">üìí LDC Book</h1>

  <div class="input-group mb-3 owner-only">
    <input type="text" id="newCustomer" class="form-control" placeholder="Customer Name">
    <button class="btn btn-success" onclick="addCustomer()">Add</button>
  </div>

  <div class="row text-center mb-4">
    <div class="col-4">
      <div class="p-3 bg-success text-white rounded">
        <h6>Total Credit</h6><h4>‚Çπ<span id="totalCredit">0</span></h4>
      </div>
    </div>
    <div class="col-4">
      <div class="p-3 bg-danger text-white rounded">
        <h6>Total Debit</h6><h4>‚Çπ<span id="totalDebit">0</span></h4>
      </div>
    </div>
    <div class="col-4">
      <div class="p-3 bg-info text-white rounded">
        <h6>Net Balance</h6><h4>‚Çπ<span id="totalBalance">0</span></h4>
      </div>
    </div>
  </div>

  <div id="customerList"></div>
</div>

<!-- Customer Modal -->
<div class="modal fade" id="customerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <button class="btn btn-light border me-2" onclick="backToList()">‚Üê Back</button>
        <h5 class="modal-title mb-0">Customer Details</h5>
      </div>
      <div class="modal-body">
        <input type="text" id="editCustomerName" class="form-control mb-2 owner-only">
        <button class="btn btn-primary btn-sm mb-3 owner-only" onclick="saveCustomerName()">Save Name</button>
        <button class="btn btn-danger btn-sm mb-3 ms-2 owner-only" onclick="deleteCustomer()">Delete Customer</button>
        <h5>Balance: ‚Çπ<span id="modalBalance">0</span></h5>

        <div class="input-group mb-3 owner-only">
          <input type="number" id="modalAmount" class="form-control" placeholder="Amount">
          <select id="modalType" class="form-select">
            <option value="credit">Credit</option>
            <option value="debit">Debit</option>
          </select>
          <button class="btn btn-primary" onclick="addModalTransaction()">Add</button>
        </div>

        <div class="transaction-list" id="modalTransactions"></div>

        <div class="mt-3">
          <button class="btn btn-outline-primary w-100" onclick="shareCustomer()">Generate Shareable Link</button>
          <input type="text" id="shareableLink" class="form-control mt-2" readonly>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Date Modal -->
<div class="modal fade" id="editDateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5>Edit Transaction Date</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="datetime-local" id="editDateInput" class="form-control mb-3">
        <button class="btn btn-success w-100" onclick="saveEditedDate()">Save Date</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
let userEmail = null;
let customers = [];
let selectedCustomerIndex = null;
let editingTransactionIndex = null;
let isReadOnly = false;

// Google Sign-In callback
function handleCredentialResponse(response) {
  const decoded = parseJwt(response.credential);
  userEmail = decoded.email;
  document.getElementById("googleSignInDiv").style.display = "none";
  document.getElementById("passwordModal").style.display = "block";
  loadUserData();
}

function parseJwt(token) {
  const base64Url = token.split('.')[1];
  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
  const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
      return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
  }).join(''));
  return JSON.parse(jsonPayload);
}

function loadUserData() {
  const saved = localStorage.getItem('customers_' + userEmail);
  customers = saved ? JSON.parse(saved) : [];
  updateCustomerList();
  updateSummary();
}

function saveUserData() {
  localStorage.setItem('customers_' + userEmail, JSON.stringify(customers));
}

// Password protection
function checkPassword() {
  const password = document.getElementById("passwordInput").value;
  const correctPassword = "1234";

  if (password === correctPassword) {
    document.getElementById("passwordModal").style.display = "none";
    document.getElementById("mainContent").style.display = "block";
  } else {
    document.getElementById("wrongPass").style.display = "block";
  }
}

function enterReadOnly() {
  isReadOnly = true;
  document.getElementById("passwordModal").style.display = "none";
  document.getElementById("mainContent").style.display = "block";
  document.querySelectorAll('.owner-only').forEach(el => el.style.display = 'none');
}

function addCustomer() {
  const name = document.getElementById("newCustomer").value.trim();
  if (!name) return alert("Enter customer name");
  customers.push({ name, transactions: [] });
  saveUserData();
  document.getElementById("newCustomer").value = "";
  updateCustomerList();
}

function updateCustomerList() {
  const list = document.getElementById("customerList");
  list.innerHTML = "";

  customers.forEach((customer, index) => {
    const balance = calculateBalance(customer.transactions);
    const card = document.createElement("div");
    card.className = "card customer-card";
    card.onclick = () => openCustomer(index);
    card.innerHTML = `
      <div class="card-body d-flex justify-content-between align-items-center">
        <h5 class="mb-0">${customer.name}</h5>
        <h5 class="mb-0">‚Çπ${balance}</h5>
      </div>`;
    list.appendChild(card);
  });

  updateSummary();
}

function updateSummary() {
  let totalCredit = 0, totalDebit = 0;
  customers.forEach(customer => {
    customer.transactions.forEach(t => {
      if (t.type === 'credit') totalCredit += t.amount;
      else totalDebit += t.amount;
    });
  });

  document.getElementById("totalCredit").innerText = totalCredit;
  document.getElementById("totalDebit").innerText = totalDebit;
  document.getElementById("totalBalance").innerText = totalCredit - totalDebit;
}

function openCustomer(index) {
  selectedCustomerIndex = index;
  const customer = customers[index];
  document.getElementById("editCustomerName").value = customer.name;
  document.getElementById("modalBalance").innerText = calculateBalance(customer.transactions);
  const transactionsDiv = document.getElementById("modalTransactions");
  transactionsDiv.innerHTML = "";

  customer.transactions.forEach((t, i) => {
    const item = document.createElement("div");
    item.className = "d-flex justify-content-between border-bottom py-2";
    item.innerHTML = `
      <div><strong class="${t.type}">‚Çπ${t.amount}</strong> <small>(${new Date(t.date).toLocaleString()})</small></div>
      ${isReadOnly ? "" : `
      <div>
        <button class="btn btn-sm btn-outline-secondary me-1" onclick="editDate(${i})">üìÖ</button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteTransaction(${i})">üóëÔ∏è</button>
      </div>`}
    `;
    transactionsDiv.appendChild(item);
  });

  new bootstrap.Modal(document.getElementById("customerModal")).show();
}

function calculateBalance(transactions) {
  return transactions.reduce((sum, t) => t.type === "credit" ? sum + t.amount : sum - t.amount, 0);
}

function saveCustomerName() {
  const newName = document.getElementById("editCustomerName").value.trim();
  if (!newName) return alert("Enter valid name");
  customers[selectedCustomerIndex].name = newName;
  saveUserData();
  updateCustomerList();
  openCustomer(selectedCustomerIndex);
}

function deleteCustomer() {
  if (confirm("Are you sure you want to delete this customer?")) {
    customers.splice(selectedCustomerIndex, 1);
    saveUserData();
    document.querySelector(".modal.show").classList.remove("show");
    document.querySelector(".modal-backdrop").remove();
    updateCustomerList();
  }
}

function addModalTransaction() {
  const amount = parseFloat(document.getElementById("modalAmount").value);
  const type = document.getElementById("modalType").value;
  if (isNaN(amount) || amount <= 0) return alert("Enter valid amount");
  customers[selectedCustomerIndex].transactions.push({ amount, type, date: new Date().toISOString() });
  saveUserData();
  document.getElementById("modalAmount").value = "";
  openCustomer(selectedCustomerIndex);
  updateCustomerList();
}

function deleteTransaction(index) {
  customers[selectedCustomerIndex].transactions.splice(index, 1);
  saveUserData();
  openCustomer(selectedCustomerIndex);
  updateCustomerList();
}

function editDate(index) {
  editingTransactionIndex = index;
  const t = customers[selectedCustomerIndex].transactions[index];
  document.getElementById("editDateInput").value = t.date.substring(0, 16);
  new bootstrap.Modal(document.getElementById("editDateModal")).show();
}

function saveEditedDate() {
  const newDate = document.getElementById("editDateInput").value;
  if (!newDate) return alert("Select valid date");
  customers[selectedCustomerIndex].transactions[editingTransactionIndex].date = new Date(newDate).toISOString();
  saveUserData();
  bootstrap.Modal.getInstance(document.getElementById("editDateModal")).hide();
  openCustomer(selectedCustomerIndex);
}

function shareCustomer() {
  const customer = customers[selectedCustomerIndex];
  const dataStr = btoa(JSON.stringify(customer));
  const url = `${window.location.origin}${window.location.pathname}?data=${dataStr}`;
  document.getElementById("shareableLink").value = url;
}

function backToList() {
  bootstrap.Modal.getInstance(document.getElementById("customerModal")).hide();
}
</script>

</body>
</html>
