<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LDC BOOK Cloud</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { background-color: #f8f9fa; }
    .customer-card { margin-bottom: 15px; cursor: pointer; transition: 0.2s; }
    .customer-card:hover { transform: scale(1.02); }
    .credit { color: green; }
    .debit { color: red; }
    .header-bar { background: #007bff; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
    .transaction-list { max-height: 300px; overflow-y: auto; }
    .balance-field { width: 120px; text-align: right; font-family: monospace; }
  </style>
</head>
<body>

<div class="container text-center mt-5" id="loginDiv">
  <h2 class="mb-4 fw-bold text-primary">ðŸ“’ LDC BOOK</h2>
  <button id="googleLogin" class="btn btn-primary">Sign In with Google</button>
  <div id="loginError" class="text-danger mt-3"></div>
</div>

<div class="header-bar" id="headerBar" style="display:none;">
  <h4 class="mb-0">ðŸ“’ LDC BOOK</h4>
  <div>
    <button class="btn btn-warning btn-sm me-2" onclick="exportData()">Backup</button>
    <button class="btn btn-info btn-sm me-2" onclick="importData()">Restore</button>
    <button class="btn btn-light btn-sm" onclick="logout()">Logout</button>
  </div>
</div>

<div id="mainContent" class="container my-4" style="display:none;">
  <div class="d-flex justify-content-between mb-3">
    <input type="text" id="searchInput" class="form-control me-2" placeholder="Search" oninput="renderCustomers()">
    <button class="btn btn-success" onclick="showAddCustomer()">+ Add Customer</button>
  </div>

  <div class="row text-center mb-4">
    <div class="col-4"><div class="p-3 bg-success text-white rounded"><h6>Total Credit</h6><h4>â‚¹<span id="totalCredit">0</span></h4></div></div>
    <div class="col-4"><div class="p-3 bg-danger text-white rounded"><h6>Total Debit</h6><h4>â‚¹<span id="totalDebit">0</span></h4></div></div>
    <div class="col-4"><div class="p-3 bg-info text-white rounded"><h6>Net Balance</h6><h4>â‚¹<span id="totalBalance">0</span></h4></div></div>
  </div>

  <div id="customerList"></div>
</div>

<!-- Add Customer Modal -->
<div class="modal fade" id="addCustomerModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5>Add Customer</h5></div>
      <div class="modal-body">
        <input type="text" id="newName" class="form-control mb-2" placeholder="Customer Name">
        <input type="text" id="newPhone" class="form-control mb-3" placeholder="Phone Number (10 digits)">
        <button class="btn btn-success w-100" onclick="addCustomer()">Add Customer</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase -->
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyCphj2j6QXn3Ks2NPHKkOoc0qS42sCuctU",
    authDomain: "ldc-maintain.firebaseapp.com",
    databaseURL: "https://ldc-maintain-default-rtdb.firebaseio.com",
    projectId: "ldc-maintain",
    storageBucket: "ldc-maintain.firebasestorage.app",
    messagingSenderId: "127227068289",
    appId: "1:127227068289:web:325decf42e3294386d7280",
    measurementId: "G-WM19FB4H03"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
let customers = [];

const allowedEmails = [
  "lokenathdriverscentre@gmail.com",
  "sarkarraj877@gmail.com",
  "sarkarkeya505@gmail.com"
];

document.getElementById("googleLogin").addEventListener("click", () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).then(({ user }) => {
    if (allowedEmails.includes(user.email)) {
      document.getElementById("loginDiv").style.display = "none";
      document.getElementById("headerBar").style.display = "flex";
      document.getElementById("mainContent").style.display = "block";
      loadData();
    } else {
      auth.signOut();
      document.getElementById("loginError").innerText = "Unauthorized Email";
    }
  });
});

function logout(){
  auth.signOut();
  location.reload();
}

function loadData(){
  db.collection("customers").onSnapshot(snapshot => {
    customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    renderCustomers();
  });
}

function renderCustomers(){
  const listDiv = customerList;
  listDiv.innerHTML = "";
  let filtered = customers.filter(c => c.name.toLowerCase().includes(searchInput.value.toLowerCase()));
  let cr=0, dr=0;
  filtered.forEach(c => {
    const bal = c.transactions.reduce((s,t)=>s+(t.type==="credit"?t.amount:-t.amount),0);
    if(bal>=0) cr+=bal; else dr+=-bal;
    listDiv.innerHTML += `<div class="card customer-card" onclick="showCustomer('${c.id}')">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div><h5>${c.name}</h5><p>${c.phone}</p></div>
        <h5 class="${bal>=0?'credit':'debit'} balance-field">â‚¹${bal.toLocaleString()}</h5>
      </div></div>`;
  });
  totalCredit.textContent = cr.toLocaleString();
  totalDebit.textContent = dr.toLocaleString();
  totalBalance.textContent = (cr-dr).toLocaleString();
}

function showAddCustomer(){
  new bootstrap.Modal(addCustomerModal).show();
}

function addCustomer(){
  const name = newName.value.trim(), phone = newPhone.value.trim();
  if (!name || !/^\d{10}$/.test(phone)) return alert("Valid name & 10-digit phone required.");
  if (customers.some(c=>c.phone===phone)) return alert("Phone exists.");
  db.collection("customers").add({ name, phone, transactions: [] });
  bootstrap.Modal.getInstance(addCustomerModal).hide();
  newName.value = ""; newPhone.value = "";
}

function showCustomer(id){
  const c = customers.find(c => c.id === id);
  let txnHTML = c.transactions.map((t,i)=>
    `<div class="border-bottom py-1 ${t.type}">${t.type.toUpperCase()}: â‚¹${t.amount} - ${t.date}</div>`).reverse().join('');
  alert(`${c.name}\nPhone: ${c.phone}\n\nTransactions:\n${txnHTML || 'No transactions yet.'}`);
}

function exportData(){
  const blob = new Blob([JSON.stringify(customers)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const dateStr = new Date().toISOString().slice(0,10);
  a.href = url; a.download = `LDC-Backup-${dateStr}.json`; a.click();
  URL.revokeObjectURL(url);
}

function importData(){
  const input = document.createElement("input");
  input.type="file";
  input.onchange = e=>{
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = async ()=>{
      try {
        const imported = JSON.parse(reader.result);
        for(const c of imported){
          await db.collection("customers").add(c);
        }
      } catch { alert("Invalid file."); }
    };
    reader.readAsText(file);
  };
  input.click();
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
