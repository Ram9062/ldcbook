<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LDC BOOK - Firebase Version</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { background-color: #f8f9fa; }
    .customer-card { margin-bottom: 15px; cursor: pointer; transition: 0.2s; }
    .customer-card:hover { transform: scale(1.02); }
    .credit { color: green; }
    .debit { color: red; }
    .header-bar { background: #007bff; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
    .transaction-list { max-height: 300px; overflow-y: auto; }
    .owner-only { display: none; }
    .balance-field { width: 120px; text-align: right; font-family: monospace; }
  </style>
</head>
<body>

<!-- Login Section -->
<div id="loginSection" class="container my-5 text-center">
  <h3 class="fw-bold text-primary">ðŸ“’ LDC BOOK</h3>
  <button class="btn btn-danger mt-3" onclick="signIn()">Sign in with Google</button>
  <div id="loginError" class="text-danger mt-3" style="display:none;"></div>
</div>

<!-- Main App -->
<div id="appSection" style="display:none;">
  <div class="header-bar">
    <h4 class="mb-0">ðŸ“’ LDC BOOK</h4>
    <div>
      <button class="btn btn-light btn-sm" onclick="signOut()">Logout</button>
    </div>
  </div>

  <div class="container my-4">
    <div class="d-flex justify-content-between mb-3">
      <input type="text" id="searchInput" class="form-control me-2" placeholder="Search" oninput="updateCustomerList()">
      <button class="btn btn-success" onclick="showAddCustomer()">+ Add Customer</button>
    </div>

    <div class="row text-center mb-4">
      <div class="col-4"><div class="p-3 bg-success text-white rounded"><h6>Total Credit</h6><h4>â‚¹<span id="totalCredit">0</span></h4></div></div>
      <div class="col-4"><div class="p-3 bg-danger text-white rounded"><h6>Total Debit</h6><h4>â‚¹<span id="totalDebit">0</span></h4></div></div>
      <div class="col-4"><div class="p-3 bg-info text-white rounded"><h6>Net Balance</h6><h4>â‚¹<span id="totalBalance">0</span></h4></div></div>
    </div>

    <div id="customerList"></div>
  </div>
</div>

<!-- Add Customer Modal -->
<div class="modal fade" id="addCustomerModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5>Add Customer</h5></div>
      <div class="modal-body">
        <input type="text" id="newName" class="form-control mb-2" placeholder="Customer Name">
        <input type="text" id="newPhone" class="form-control mb-3" placeholder="Phone Number (10 digits)">
        <button class="btn btn-success w-100" onclick="addCustomer()">Add Customer</button>
      </div>
    </div>
  </div>
</div>

<!-- Customer Modal -->
<div class="modal fade" id="customerModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5>Customer Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <h5 id="customerName"></h5>
        <p id="customerPhone"></p>
        <h5>Balance: â‚¹<span id="modalBalance">0</span></h5>

        <div class="row mb-3">
          <div class="col-md-3 mb-1"><input type="number" id="txnAmount" class="form-control" placeholder="Amount"></div>
          <div class="col-md-3 mb-1"><select id="txnType" class="form-select"><option value="credit">Credit</option><option value="debit">Debit</option></select></div>
          <div class="col-md-4 mb-1"><input type="datetime-local" id="txnDate" class="form-control"></div>
          <div class="col-md-2 mb-1"><button class="btn btn-primary w-100" onclick="addTransaction()">Add</button></div>
        </div>

        <div class="transaction-list" id="txnList"></div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>

<script>
// Your Firebase Config
const firebaseConfig = {
    apiKey: "AIzaSyCphj2j6QXn3Ks2NPHKkOoc0qS42sCuctU",
    authDomain: "ldc-maintain.firebaseapp.com",
    databaseURL: "https://ldc-maintain-default-rtdb.firebaseio.com",
    projectId: "ldc-maintain",
    storageBucket: "ldc-maintain.firebasestorage.app",
    messagingSenderId: "127227068289",
    appId: "1:127227068289:web:325decf42e3294386d7280",
    measurementId: "G-WM19FB4H03""
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
let customers = [], selectedCustomer = null;
const allowedEmails = [
  "lokenathdriverscentre@gmail.com",
  "sarkarraj877@gmail.com",
  "sarkarkeya505@gmail.com"
];

// Login
function signIn() {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider)
    .then(result => {
      const email = result.user.email;
      if (allowedEmails.includes(email)) {
        document.getElementById("loginSection").style.display = 'none';
        document.getElementById("appSection").style.display = 'block';
        subscribeToData();
      } else {
        document.getElementById("loginError").innerText = "Unauthorized Email";
        document.getElementById("loginError").style.display = "block";
        auth.signOut();
      }
    })
    .catch(err => alert(err.message));
}

function signOut() {
  auth.signOut();
  location.reload();
}

// Real-time Firestore listener
function subscribeToData() {
  db.collection("customers").onSnapshot(snapshot => {
    customers = [];
    snapshot.forEach(doc => customers.push({ id: doc.id, ...doc.data() }));
    updateCustomerList();
    updateSummary();
  });
}

function updateCustomerList() {
  const listDiv = customerList;
  listDiv.innerHTML = "";
  let filtered = customers.filter(c => c.name.toLowerCase().includes(searchInput.value.toLowerCase()));
  filtered.sort((a,b) => a.name.localeCompare(b.name));
  filtered.forEach(c => {
    const bal = calculateBalance(c);
    listDiv.innerHTML += `<div class="card customer-card" onclick="openCustomer('${c.id}')">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div><h5>${c.name}</h5><p>${c.phone}</p></div>
        <h5 class="${bal>=0?'credit':'debit'} balance-field">â‚¹${bal.toLocaleString()}</h5>
      </div></div>`;
  });
}

function calculateBalance(c) {
  return (c.transactions || []).reduce((s,t)=>s+(t.type==="credit"?t.amount:-t.amount),0);
}

function updateSummary() {
  let cr=0, dr=0;
  customers.forEach(c => (c.transactions||[]).forEach(t => t.type==="credit"?cr+=t.amount:dr+=t.amount));
  totalCredit.textContent=cr.toLocaleString();
  totalDebit.textContent=dr.toLocaleString();
  totalBalance.textContent=(cr-dr).toLocaleString();
}

function showAddCustomer() {
  new bootstrap.Modal(addCustomerModal).show();
}

async function addCustomer() {
  const name = newName.value.trim();
  const phone = newPhone.value.trim();
  if (!name || !/^[0-9]{10}$/.test(phone)) return alert("Valid name & phone required");

  const existing = await db.collection("customers").where("phone","==",phone).get();
  if (!existing.empty) return alert("Phone exists.");

  await db.collection("customers").add({ name, phone, transactions: [] });
  newName.value = ""; newPhone.value = "";
  bootstrap.Modal.getInstance(addCustomerModal).hide();
}

function openCustomer(id) {
  selectedCustomer = customers.find(c => c.id === id);
  customerName.innerText = selectedCustomer.name;
  customerPhone.innerText = selectedCustomer.phone;
  modalBalance.textContent = calculateBalance(selectedCustomer).toLocaleString();
  txnDate.value = new Date().toISOString().slice(0,16);
  txnList.innerHTML = (selectedCustomer.transactions||[]).map(t=>`<div class="border-bottom py-1 ${t.type}">
    ${t.type.toUpperCase()}: â‚¹${t.amount.toLocaleString()} - ${t.date}</div>`).reverse().join('');
  new bootstrap.Modal(customerModal).show();
}

async function addTransaction() {
  const amount = parseFloat(txnAmount.value);
  const type = txnType.value;
  const date = txnDate.value;
  if (!amount || amount <= 0 || !date) return alert("Valid amount & date required.");

  selectedCustomer.transactions.push({ amount, type, date });
  await db.collection("customers").doc(selectedCustomer.id).update({ transactions: selectedCustomer.transactions });
  txnAmount.value = "";
  txnDate.value = new Date().toISOString().slice(0,16);
  openCustomer(selectedCustomer.id);
}
</script>
</body>
</html>
